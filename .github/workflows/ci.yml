name: Build and Push Docker Images

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'k8s/**'  # Don't rebuild if we only change k8s files!
      - 'README.md'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. Download your code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Build & Push API Server
      - name: Build and Push API Server
        uses: docker/build-push-action@v5
        with:
          context: ./api-server  # ðŸ‘ˆ Check if this folder name matches yours!
          file: ./api-server/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/mini-vercel-api:latest

      # 4. Build & Push Build Server
      - name: Build and Push Build Server
        uses: docker/build-push-action@v5
        with:
          context: ./build-server # ðŸ‘ˆ Check if this folder name matches yours!
          file: ./build-server/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/mini-vercel-build-server:latest

      # 5. Build & Push Proxy
      - name: Build and Push Reverse Proxy
        uses: docker/build-push-action@v5
        with:
          context: ./reverse-proxy # ðŸ‘ˆ Check if this folder name matches yours!
          file: ./reverse-proxy/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/mini-vercel-proxy:latest